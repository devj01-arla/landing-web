---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Login | Arla & Asociados">
  <Navbar />
  <main class="relative h-screen pt-20 overflow-hidden">
    <!-- Imagen de fondo -->
    <div class="fixed inset-0 z-0">
      <img 
        src="/fondo.png" 
        alt="Fondo decorativo" 
        class="w-full h-full object-cover"
      />
    </div>

    <div class="relative flex items-center justify-center h-[calc(100vh-5rem)] px-4 sm:px-6 lg:px-8 py-12 z-20">
      <div class="w-full max-w-md">
        <!-- T칤tulo -->
        <div class="text-center mb-10 reveal">
          <h1 class="text-4xl font-bold text-white font-poppins mb-3 drop-shadow-md">Inicio de Sesi칩n</h1>
        </div>

        <!-- Formulario de login -->
        <div class="bg-white/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 p-10 reveal-left relative z-20">
          <form id="loginForm" class="space-y-6" autocomplete="on">
            <!-- Campo Usuario/Email -->
            <div class="form-group">
              <label for="username" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Usuario o Email
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </div>
                <input
                  type="text"
                  id="username"
                  name="username"
                  class="block w-full pl-10 pr-3 py-3.5 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-arla-blue focus:border-arla-blue transition-all duration-200 font-inter bg-white"
                  placeholder="Ingrese su usuario o email"
                  required
                  autocomplete="username"
                />
              </div>
              <div class="error-message hidden mt-1"></div>
            </div>

            <!-- Campo Contrase침a -->
            <div class="form-group">
              <label for="password" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Contrase침a
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="block w-full pl-10 pr-10 py-3.5 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-arla-blue focus:border-arla-blue transition-all duration-200 font-inter bg-white"
                  placeholder="Ingrese su contrase침a"
                  required
                  autocomplete="current-password"
                />
                <button
                  type="button"
                  id="togglePassword"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors duraci칩n-200"
                  aria-label="Mostrar/Ocultar contrase침a"
                >
                  <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                </button>
              </div>
              <div class="error-message hidden mt-1"></div>
            </div>

            <!-- Recordar sesi칩n y olvid칠 contrase침a -->
            <div class="flex items-center justify-between pt-2">
              <div class="flex items-center">
                <input
                  id="remember"
                  name="remember"
                  type="checkbox"
                  class="h-4 w-4 text-arla-blue focus:ring-arla-blue border-gray-300 rounded transition-colors duration-200 cursor-pointer"
                />
                <label for="remember" class="ml-2 block text-sm text-gray-700 font-inter cursor-pointer">
                  Recordar sesi칩n
                </label>
              </div>
              <div class="text-sm">
                <a href="/forgot-password" class="font-medium text-arla-blue hover:text-blue-700 transition-colors duration-200 font-inter">
                  쯆lvid칩 su contrase침a?
                </a>
              </div>
            </div>

            <!-- Bot칩n de env칤o -->
            <button
              type="submit"
              id="submitButton"
              class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-lg shadow-lg text-base font-semibold text-white bg-arla-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-arla-blue transition-all duration-300 font-poppins disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
            >
              <span id="button-text">Iniciar Sesi칩n</span>
              <svg id="loading-spinner" class="hidden ml-2 h-5 w-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
            
            <!-- Enlace de registro -->
            <div class="mt-4 text-center">
              <a href="/register" class="text-sm font-medium text-arla-blue hover:text-blue-700 transition-colors duration-200 font-inter">
                쯅o tienes cuenta? Reg칤strate
              </a>
            </div>
          </form>
        </div>

        <!-- Mensaje de ayuda -->
        <div class="mt-8 text-center reveal-right">
          <p class="text-sm text-gray-200 font-inter">
            쯅ecesita ayuda? 
            <a href="/#contact" class="font-medium text-white hover:text-blue-200 transition-colors duration-200 underline underline-offset-2">
              Cont치ctenos
            </a>
          </p>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<!-- Notificaciones -->
<div id="notifications" class="fixed top-4 right-4 z-50">
  <!-- Error -->
  <div id="errorNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-red-500">
    <div class="flex items-start gap-3">
      <svg class="w-6 h-6 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      <div class="flex flex-col gap-2">
        <p class="text-gray-700 font-inter" id="error-message">Error al iniciar sesi칩n</p>
        <button
          id="resendVerificationButton"
          class="hidden inline-flex items-center text-sm font-medium text-arla-blue hover:text-blue-700 underline underline-offset-2"
          type="button"
        >
          Reenviar correo de verificaci칩n
        </button>
      </div>
    </div>
  </div>

  <!-- 칄xito -->
  <div id="successNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-green-500">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <p class="text-gray-700 font-inter" id="success-message">
        Acci칩n realizada correctamente.
      </p>
    </div>
  </div>
</div>

<style>
  /* Deshabilitar scroll solo en la p치gina de login */
  html.login-page,
  body.login-page {
    overflow: hidden !important;
    height: 100vh !important;
    position: relative !important;
    width: 100% !important;
  }

  /* Estilos para hacer el navbar est치tico solo en login */
  #navbar {
    background-color: rgba(255, 255, 255, 0.95) !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    border-bottom: 1px solid rgba(229, 231, 235, 1) !important;
    transition: none !important;
  }

  #navbar.bg-white\/95,
  #navbar.bg-transparent,
  #navbar[class*="bg-"] {
    background-color: rgba(255, 255, 255, 0.95) !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    border-bottom: 1px solid rgba(229, 231, 235, 1) !important;
  }

  #navbar #logo-container {
    opacity: 1 !important;
    pointer-events: auto !important;
    transition: none !important;
  }

  #navbar #logo-container.opacity-0,
  #navbar #logo-container[class*="opacity-"] {
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Ocultar completamente los botones de navegaci칩n en la p치gina de login */
  #navbar #nav-items,
  #navbar #nav-items * {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
  }

  #navbar #menu-button-container,
  #navbar #menu-button-container * {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
  }

  .form-group {
    position: relative;
  }

  .error-message {
    color: #dc2626;
    font-size: 0.875rem;
    font-family: 'Inter', sans-serif;
  }

  .error-input {
    border-color: #dc2626 !important;
  }

  .error-label {
    color: #dc2626 !important;
  }

  .hidden {
    display: none;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  .reveal {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s ease-in-out;
    will-change: transform, opacity;
  }

  .reveal.active {
    opacity: 1;
    transform: translateY(0);
  }

  .reveal-left {
    opacity: 0;
    transform: translateX(-50px);
    transition: all 0.8s ease-in-out;
    will-change: transform, opacity;
  }

  .reveal-right {
    opacity: 0;
    transform: translateX(50px);
    transition: all 0.8s ease-in-out;
    will-change: transform, opacity;
  }

  .reveal-left.active,
  .reveal-right.active {
    opacity: 1;
    transform: translateX(0);
  }

  @media (max-width: 768px) {
    .reveal,
    .reveal-left,
    .reveal-right {
      transform: none;
      opacity: 1;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Prevenir scroll en la p치gina de login
    document.documentElement.classList.add('login-page');
    document.body.classList.add('login-page');
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.style.height = '100vh';
    document.documentElement.style.height = '100vh';
    
    function preventScroll(e) {
      e.preventDefault();
      return false;
    }
    
    document.addEventListener('wheel', preventScroll, { passive: false });
    document.addEventListener('touchmove', preventScroll, { passive: false });
    document.addEventListener('scroll', preventScroll, { passive: false });
    
    document.addEventListener('keydown', function(e) {
      if (['ArrowUp', 'ArrowDown', 'PageUp', 'PageDown', 'Home', 'End', ' '].includes(e.key)) {
        e.preventDefault();
        return false;
      }
    });

    const navbar = document.getElementById('navbar');
    const navItems = document.getElementById('nav-items');
    const logoContainer = document.getElementById('logo-container');
    const menuButtonContainer = document.getElementById('menu-button-container');
    
    function forceNavbarStatic() {
      if (navbar) {
        navbar.classList.add('bg-white/95', 'shadow-lg', 'border-b', 'border-gray-100');
        navbar.classList.remove('bg-transparent');
      }
      
      if (logoContainer) {
        logoContainer.classList.remove('opacity-0', 'pointer-events-none');
        logoContainer.classList.add('opacity-100', 'pointer-events-auto');
      }
      
      if (navItems) {
        navItems.style.display = 'none';
        navItems.style.visibility = 'hidden';
        navItems.style.opacity = '0';
        navItems.style.pointerEvents = 'none';
        navItems.classList.add('hidden');
      }
      
      if (menuButtonContainer) {
        menuButtonContainer.style.display = 'none';
        menuButtonContainer.style.visibility = 'hidden';
        menuButtonContainer.classList.add('hidden');
      }
    }
    
    forceNavbarStatic();
    
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(() => {
        forceNavbarStatic();
      }, 10);
    }, { passive: true });
    
    window.addEventListener('resize', () => {
      forceNavbarStatic();
    });

    const form = document.getElementById('loginForm');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeOffIcon = document.getElementById('eyeOffIcon');

    if (togglePassword && passwordInput && eyeIcon && eyeOffIcon) {
      togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        eyeIcon.classList.toggle('hidden');
        eyeOffIcon.classList.toggle('hidden');
      });
    }

    function showError(field, message) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');
      
      field.classList.add('error-input');
      if (label) label.classList.add('error-label');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    function clearError(field) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');
      
      field.classList.remove('error-input');
      if (label) label.classList.remove('error-label');
      if (errorDiv) errorDiv.classList.add('hidden');
    }

    function showNotification(message) {
      const notification = document.getElementById('errorNotification');
      const messageElement = document.getElementById('error-message');
      if (notification && messageElement) {
        messageElement.textContent = message;
        notification.classList.remove('hidden');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 5000);
      }
    }

    ['username', 'password'].forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('blur', () => {
          if (!field.value.trim()) {
            showError(field, 'Este campo es obligatorio');
          }
        });

        field.addEventListener('input', () => {
          if (field.value.trim()) {
            clearError(field);
          }
        });
      }
    });

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        let hasErrors = false;

        ['username', 'password'].forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && !field.value.trim()) {
            showError(field, 'Este campo es obligatorio');
            hasErrors = true;
          }
        });

        if (hasErrors) return;

        if (submitButton && buttonText && loadingSpinner) {
          submitButton.disabled = true;
          buttonText.textContent = 'Iniciando sesi칩n...';
          loadingSpinner.classList.remove('hidden');
        }

        try {
          const usernameField = document.getElementById('username');
          const passwordField = document.getElementById('password');
          const username = usernameField?.value || '';
          const password = passwordField?.value || '';

          const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          let data = null;
          try {
            data = await response.json();
          } catch (_) {
            data = null;
          }

          if (!response.ok) {
            const msg = (data?.message || '').toLowerCase();

            // 游뚿 Cuenta no verificada: redirigimos a /verificar-cuenta
            if (response.status === 403 && msg.includes('no ha sido verificada')) {
              window.location.href =
                '/verificar-cuenta?email=' + encodeURIComponent(username) + '&origin=login';
              return;
            }

            // Otros errores normales de login
            showNotification(data?.message || 'Credenciales inv치lidas. Por favor, intente nuevamente.');
            return;
          }

          // Login correcto
          window.location.href = '/panel';
        } catch (error) {
          console.error(error);
          showNotification('Error al conectar con el servidor. Por favor, intente m치s tarde.');
        } finally {
          if (submitButton && buttonText && loadingSpinner) {
            submitButton.disabled = false;
            buttonText.textContent = 'Iniciar Sesi칩n';
            loadingSpinner.classList.add('hidden');
          }
        }
      });
    }

    function initScrollReveal() {
      const options = {
        threshold: 0.1,
        rootMargin: "0px 0px -50px 0px"
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
          }
        });
      }, options);

      document.querySelectorAll('.reveal, .reveal-left, .reveal-right').forEach((element) => {
        observer.observe(element);
      });
    }

    initScrollReveal();
  });
</script>

