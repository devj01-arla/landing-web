---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Recuperar contraseña | Arla & Asociados">
  <Navbar />
  <main class="relative h-screen pt-20 overflow-hidden">
    <!-- Imagen de fondo -->
    <div class="fixed inset-0 z-0">
      <img 
        src="/fondo.png" 
        alt="Fondo decorativo" 
        class="w-full h-full object-cover"
      />
    </div>

    <div class="relative flex items-center justify-center h-[calc(100vh-5rem)] px-4 sm:px-6 lg:px-8 py-12 z-20">
      <div class="w-full max-w-md">
        <!-- Título -->
        <div class="text-center mb-10">
          <h1 class="text-3xl font-bold text-white font-poppins mb-3 drop-shadow-md">
            Recuperar contraseña
          </h1>
          <p class="text-sm text-gray-200 font-inter">
            Ingresa el correo con el que te registraste y te enviaremos un enlace para restablecer tu contraseña.
          </p>
        </div>

        <!-- Formulario -->
        <div class="bg-white/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 p-8 relative z-20">
          <form id="forgotForm" class="space-y-6" autocomplete="on">
            <div class="form-group">
              <label for="email" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Correo electrónico
              </label>
              <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="block w-full pl-10 pr-3 py-3.5 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-arla-blue focus:border-arla-blue transition-all duration-200 font-inter bg-white"
                  placeholder="Ingrese su correo"
                  required
                  autocomplete="email"
                />
              </div>
              <div class="error-message hidden mt-1"></div>
            </div>

            <button
              type="submit"
              id="submitButton"
              class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-lg shadow-lg text-base font-semibold text-white bg-arla-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-arla-blue transition-all duration-300 font-poppins disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="button-text">Enviar enlace</span>
              <svg id="loading-spinner" class="hidden ml-2 h-5 w-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>

            <div class="mt-4 text-center">
              <a href="/login" class="text-sm font-medium text-arla-blue hover:text-blue-700 transition-colors duration-200 font-inter">
                Volver al inicio de sesión
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<!-- Notificaciones -->
<div id="notifications" class="fixed top-4 right-4 z-50">
  <div id="errorNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-red-500">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      <p class="text-gray-700 font-inter" id="error-message">Error al procesar la solicitud</p>
    </div>
  </div>
  <div id="successNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-green-500">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <p class="text-gray-700 font-inter" id="success-message">Solicitud enviada</p>
    </div>
  </div>
</div>

<style>
  /* Deshabilitar scroll solo en la página de recuperar contraseña */
  html.forgot-page,
  body.forgot-page {
    overflow: hidden !important;
    height: 100vh !important;
    position: relative !important;
    width: 100% !important;
  }

  .form-group { position: relative; }
  .error-message {
    color: #dc2626;
    font-size: 0.875rem;
    font-family: 'Inter', sans-serif;
  }
  .error-input { border-color: #dc2626 !important; }
  .error-label { color: #dc2626 !important; }
  .hidden { display: none; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Bloquear scroll igual que en login/register
    document.documentElement.classList.add('forgot-page');
    document.body.classList.add('forgot-page');
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    document.body.style.height = '100vh';
    document.documentElement.style.height = '100vh';

    function preventScroll(e) {
      e.preventDefault();
      return false;
    }

    // Bloqueo de scroll con rueda / touch / scroll
    document.addEventListener('wheel', preventScroll, { passive: false });
    document.addEventListener('touchmove', preventScroll, { passive: false });
    document.addEventListener('scroll', preventScroll, { passive: false });

    // Bloqueo de scroll con teclado
    document.addEventListener('keydown', function (e) {
      if (['ArrowUp', 'ArrowDown', 'PageUp', 'PageDown', 'Home', 'End', ' '].includes(e.key)) {
        e.preventDefault();
        return false;
      }
    });

    const form = document.getElementById('forgotForm');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    function showError(field, message) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');

      field.classList.add('error-input');
      if (label) label.classList.add('error-label');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    function clearError(field) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');

      field.classList.remove('error-input');
      if (label) label.classList.remove('error-label');
      if (errorDiv) errorDiv.classList.add('hidden');
    }

    function showNotification(type, message) {
      const notification = document.getElementById(`${type}Notification`);
      const messageElement = document.getElementById(`${type}-message`);
      if (notification && messageElement) {
        messageElement.textContent = message;
        notification.classList.remove('hidden');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 6000);
      }
    }

    const emailField = document.getElementById('email');
    if (emailField) {
      emailField.addEventListener('blur', () => {
        if (!emailField.value.trim()) {
          showError(emailField, 'Este campo es obligatorio');
        }
      });
      emailField.addEventListener('input', () => {
        if (emailField.value.trim()) {
          clearError(emailField);
        }
      });
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!emailField.value.trim()) {
          showError(emailField, 'Este campo es obligatorio');
          return;
        }

        submitButton.disabled = true;
        buttonText.textContent = 'Enviando...';
        loadingSpinner.classList.remove('hidden');

        try {
          const res = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: emailField.value.trim() }),
          });

          const data = await res.json().catch(() => null);

          if (!res.ok) {
            showNotification('error', data?.message || 'Error al procesar la solicitud.');
          } else {
            showNotification(
              'success',
              data?.message ||
                'Si el correo existe, se ha enviado un enlace para restablecer la contraseña.'
            );
          }
        } catch (err) {
          console.error(err);
          showNotification('error', 'Error al conectar con el servidor.');
        } finally {
          submitButton.disabled = false;
          buttonText.textContent = 'Enviar enlace';
          loadingSpinner.classList.add('hidden');
        }
      });
    }
  });
</script>
