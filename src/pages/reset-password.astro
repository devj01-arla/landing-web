---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Nueva contraseña | Arla & Asociados">
  <Navbar />
  <main class="relative h-screen pt-20 overflow-hidden">
    <div class="fixed inset-0 z-0">
      <img 
        src="/fondo.png" 
        alt="Fondo decorativo" 
        class="w-full h-full object-cover"
      />
    </div>

    <div class="relative flex items-center justify-center h-[calc(100vh-5rem)] px-4 sm:px-6 lg:px-8 py-12 z-20">
      <div class="w-full max-w-md">
        <div class="text-center mb-10">
          <h1 class="text-3xl font-bold text-white font-poppins mb-3 drop-shadow-md">
            Crear nueva contraseña
          </h1>
          <p class="text-sm text-gray-200 font-inter">
            Ingresa tu nueva contraseña. El enlace que recibiste tiene un tiempo limitado.
          </p>
        </div>

        <div class="bg-white/95 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 p-8 relative z-20">
          <form id="resetForm" class="space-y-6" autocomplete="off">
            <input type="hidden" id="token" />

            <div class="form-group">
              <label for="password" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Nueva contraseña
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="block w-full px-3 py-3.5 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-arla-blue focus:border-arla-blue transition-all duration-200 font-inter bg-white"
                  placeholder="Ingrese la nueva contraseña"
                  required
                />
              </div>
              <div class="error-message hidden mt-1"></div>
            </div>

            <div class="form-group">
              <label for="confirmPassword" class="block text-sm font-medium text-gray-700 font-inter mb-2">
                Confirmar contraseña
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  class="block w-full px-3 py-3.5 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-arla-blue focus:border-arla-blue transition-all duration-200 font-inter bg-white"
                  placeholder="Repita la nueva contraseña"
                  required
                />
              </div>
              <div class="error-message hidden mt-1"></div>
            </div>

            <button
              type="submit"
              id="submitButton"
              class="w-full flex justify-center items-center py-3.5 px-4 border border-transparent rounded-lg shadow-lg text-base font-semibold text-white bg-arla-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-arla-blue transition-all duration-300 font-poppins disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="button-text">Guardar contraseña</span>
              <svg id="loading-spinner" class="hidden ml-2 h-5 w-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>

            <div class="mt-4 text-center">
              <a href="/login" class="text-sm font-medium text-arla-blue hover:text-blue-700 transition-colors duration-200 font-inter">
                Volver al inicio de sesión
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<div id="notifications" class="fixed top-4 right-4 z-50">
  <div id="errorNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-red-500">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      <p class="text-gray-700 font-inter" id="error-message">Error al restablecer la contraseña</p>
    </div>
  </div>
  <div id="successNotification" class="bg-white shadow-lg rounded-lg p-4 mb-4 hidden border-l-4 border-green-500">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <p class="text-gray-700 font-inter" id="success-message">Contraseña actualizada</p>
    </div>
  </div>
</div>

<style>
  .form-group { position: relative; }
  .error-message {
    color: #dc2626;
    font-size: 0.875rem;
    font-family: 'Inter', sans-serif;
  }
  .error-input { border-color: #dc2626 !important; }
  .error-label { color: #dc2626 !important; }
  .hidden { display: none; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const tokenInput = document.getElementById('token');

    if (!token || !tokenInput) {
      alert('Enlace de restablecimiento inválido.');
      window.location.href = '/login';
      return;
    }

    tokenInput.value = token;

    const form = document.getElementById('resetForm');
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirmPassword');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    function showError(field, message) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');

      field.classList.add('error-input');
      if (label) label.classList.add('error-label');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    function clearError(field) {
      const formGroup = field.closest('.form-group');
      const label = formGroup?.querySelector('label');
      const errorDiv = formGroup?.querySelector('.error-message');

      field.classList.remove('error-input');
      if (label) label.classList.remove('error-label');
      if (errorDiv) errorDiv.classList.add('hidden');
    }

    function showNotification(type, message) {
      const notification = document.getElementById(`${type}Notification`);
      const messageElement = document.getElementById(`${type}-message`);
      if (notification && messageElement) {
        messageElement.textContent = message;
        notification.classList.remove('hidden');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 6000);
      }
    }

    if (passwordField) {
      passwordField.addEventListener('input', () => {
        if (passwordField.value.trim()) {
          clearError(passwordField);
        }
      });
    }

    if (confirmPasswordField) {
      confirmPasswordField.addEventListener('input', () => {
        if (confirmPasswordField.value.trim()) {
          clearError(confirmPasswordField);
        }
      });
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        let hasErrors = false;

        if (!passwordField.value.trim()) {
          showError(passwordField, 'Este campo es obligatorio');
          hasErrors = true;
        } else if (passwordField.value.length < 8) {
          showError(passwordField, 'La contraseña debe tener al menos 8 caracteres');
          hasErrors = true;
        }

        if (!confirmPasswordField.value.trim()) {
          showError(confirmPasswordField, 'Este campo es obligatorio');
          hasErrors = true;
        } else if (confirmPasswordField.value !== passwordField.value) {
          showError(confirmPasswordField, 'Las contraseñas no coinciden');
          hasErrors = true;
        }

        if (hasErrors) return;

        submitButton.disabled = true;
        buttonText.textContent = 'Guardando...';
        loadingSpinner.classList.remove('hidden');

        try {
          const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token: tokenInput.value,
              password: passwordField.value,
            }),
          });

          const data = await res.json().catch(() => null);

          if (!res.ok) {
            showNotification('error', data?.message || 'Error al restablecer la contraseña.');
          } else {
            showNotification('success', data?.message || 'Contraseña actualizada correctamente.');
            setTimeout(() => {
              window.location.href = '/login';
            }, 2500);
          }
        } catch (err) {
          console.error(err);
          showNotification('error', 'Error al conectar con el servidor.');
        } finally {
          submitButton.disabled = false;
          buttonText.textContent = 'Guardar contraseña';
          loadingSpinner.classList.add('hidden');
        }
      });
    }
  });
</script>
